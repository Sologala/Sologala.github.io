<!DOCTYPE html>
<html>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MMDetection 用户笔记 - DawsonWen的个人网站</title>
    <meta name="author"  content="DawsonWen">
    <meta name="description" content="MMDetection 用户笔记">
    <meta name="keywords"  content="Python">
    <!-- Open Graph -->
    <meta property="og:title" content="MMDetection 用户笔记 - DawsonWen的个人网站">
    <meta property="og:type" content="website">
    <meta property="og:url" content="http://localhost:4000/2021/06/20/mmdetection.html">
    <meta property="og:description" content="为天地立心, 为生民立命, 为往圣继绝学, 为万世开太平">
    <meta property="og:site_name" content="DawsonWen的个人网站">
    <link rel="stylesheet" href="//cdn.staticfile.org/normalize/6.0.0/normalize.min.css">
    <link rel="stylesheet" href="//at.alicdn.com/t/font_roc50gemkxpw4s4i.css">
    <link rel="stylesheet" href="/assets/css/github-markdown.css">
    <link rel="stylesheet" href="/assets/css/prism.css">
    <link rel="stylesheet" href="/assets/css/share.min.css">
    <link rel="stylesheet" href="/assets/css/app.min.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.staticfile.org/jquery/3.2.1/jquery.min.js"></script>
	
	<!--
Author: Ray-Eldath
refer to:
 - http://docs.mathjax.org/en/latest/options/index.html
-->

	<script type="text/javascript" async src="https://cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
	
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
		jax: ["input/TeX", "output/HTML-CSS"],
		tex2jax: {
			inlineMath: [ ["$", "$"], ["\\(","\\)"] ],
			displayMath: [ ["$$", "$$"], ["\\[","\\]"] ],
			skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
		},
		"HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
      });
    </script>


	
    <!--
Author: Ray-Eldath
-->
<style>
    .markdown-body .anchor{
        float: left;
        margin-top: -8px;
        margin-left: -20px;
        padding-right: 4px;
        line-height: 1;
        opacity: 0;
    }
    
    .markdown-body .anchor .anchor-icon{
        font-size: 15px
    }
</style>
<script>
    $(document).ready(function() {
        let nodes = document.querySelector(".markdown-body").querySelectorAll("h1,h2,h3")
        for(let node of nodes) {
            var anchor = document.createElement("a")
            var anchorIcon = document.createElement("i")
            anchorIcon.setAttribute("class", "fa fa-anchor fa-lg anchor-icon")
            anchorIcon.setAttribute("aria-hidden", true)
            anchor.setAttribute("class", "anchor")
            anchor.setAttribute("href", "#" + node.getAttribute("id"))
            
            anchor.onmouseover = function() {
                this.style.opacity = "0.4"
            }
            
            anchor.onmouseout = function() {
                this.style.opacity = "0"
            }
            
            anchor.appendChild(anchorIcon)
            node.appendChild(anchor)
        }
    })
</script>
	
    <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?671e6ffb306c963dfa227c8335045b4f";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
		
        })();
    </script>

</head>


<body>
  <!--[if lt IE 10]>
<div class="alert-danger" role="alert">你的浏览器实在太太太旧了，放学别走，升级完浏览器再说！<a target="_blank" class="alert-link" href="http://browsehappy.com">立即升级</a></div>
<![endif]-->
  <input id="nm-switch" type="hidden" value="true"> <header class="g-header">
    <div class="g-logo">
      <a href="/"></a>
    </div>
    <i id="menu-toggle" class="iconfont icon-menu"></i>
    <nav class="g-nav">
        <ul>
            
            <li><a href="/">home</a></li>
            
            <li><a href="/tags.html">tags</a></li>
            
        </ul>
    </nav>
</header>


  <header
    class="g-banner post-header post-pattern-circuitBoard bgcolor-default "
    data-theme="default"
  >
    <div class="post-wrapper">
      <div class="post-tags">
        
          
            <a href="/tags.html#Python" class="post-tag">Python</a>
          
        
      </div>
      <h1>MMDetection 用户笔记</h1>
      <div class="post-meta">
        <span class="post-meta-item"><i class="iconfont icon-author"></i>郑之杰</span>
        <time class="post-meta-item" datetime="21-06-20"><i class="iconfont icon-date"></i>20 Jun 2021</time>
      </div>
    </div>
    
    <div class="filter"></div>
      <div class="post-cover" style="background: url('https://pic.imgdb.cn/item/6554370ac458853aef3d6601.jpg') center no-repeat; background-size: cover;"></div>
    
  </header>

  <div class="post-content visible">
    

    <article class="markdown-body">
      <blockquote>
  <p>Notes about MMDetection.</p>
</blockquote>

<h1 id="1-训练模型">1. 训练模型</h1>

<ol>
  <li><code class="language-plaintext highlighter-rouge">tools/train.py</code>：训练模型</li>
  <li>使用定制数据集进行训练</li>
  <li>类别不平衡数据集的重采样</li>
  <li>训练时应用图像的数据增强</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/analyze_logs.py</code>：绘制学习曲线与评估训练速度</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/optimize_anchors.py</code>：Anchor尺寸先验</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/mot/browse_dataset.py</code>：浏览数据集</li>
</ol>

<h2 id="1toolstrainpy">（1）<code class="language-plaintext highlighter-rouge">tools/train.py</code></h2>

<p><code class="language-plaintext highlighter-rouge">tools/train.py</code>可用于训练模型。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Single-gpu training
</span><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">train</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">work</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="p">{</span><span class="n">WORK_DIR</span><span class="p">}]</span> \ <span class="c1"># 指定训练的工作目录
</span>    <span class="p">[</span><span class="o">--</span><span class="n">resume</span> <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}]</span> \ <span class="c1"># 从特定检查点恢复训练，若不指定则自动从work_dir中最新的检查点恢复
</span>    <span class="p">[</span><span class="o">--</span><span class="n">cfg</span><span class="o">-</span><span class="n">options</span> <span class="s">'Key=value'</span><span class="p">]</span> <span class="c1"># 覆盖配置文件中的键值对
</span>
<span class="c1"># CPU: disable GPUs and run single-gpu training script
</span><span class="n">export</span> <span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=-</span><span class="mi">1</span>
<span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">train</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">work</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="p">{</span><span class="n">WORK_DIR</span><span class="p">}]</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">resume</span> <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}]</span>

<span class="c1"># Multi-gpu training
</span><span class="n">bash</span> <span class="p">.</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">dist_train</span><span class="p">.</span><span class="n">sh</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">GPU_NUM</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">work</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="p">{</span><span class="n">WORK_DIR</span><span class="p">}]</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">resume</span> <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}]</span>
</code></pre></div></div>

<h3 id="-通过--cfg-options修改配置文件">⚪ 通过<code class="language-plaintext highlighter-rouge">--cfg-options</code>修改配置文件</h3>

<p>训练时还可以通过<code class="language-plaintext highlighter-rouge">--cfg-options</code>传递配置文件键值对的修改信息，比如调整验证集上的评估间隔（默认为$1$ <strong>epoch</strong>）：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">train</span><span class="p">.</span><span class="n">py</span> \
    <span class="p">...</span>
    <span class="o">--</span><span class="n">cfg</span><span class="o">-</span><span class="n">options</span> <span class="n">model</span><span class="p">.</span><span class="n">train_cfg</span><span class="p">.</span><span class="n">val_interval</span><span class="o">=</span><span class="mi">5</span>
</code></pre></div></div>

<h3 id="---auto-scale-lr学习率自动缩放">⚪ <code class="language-plaintext highlighter-rouge">--auto-scale-lr</code>学习率自动缩放</h3>

<p>配置文件中的默认学习率适用于 $8$ 个 <strong>GPU</strong>、每个 <strong>GPU</strong> $2$ 个样本（<strong>batch size</strong> $16$）。通过设置学习率自动缩放，学习率将根据机器上的 <strong>GPU</strong> 数量和训练批量大小自动缩放。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">train</span><span class="p">.</span><span class="n">py</span> \
    <span class="p">...</span>
    <span class="o">--</span><span class="n">auto</span><span class="o">-</span><span class="n">scale</span><span class="o">-</span><span class="n">lr</span> \
</code></pre></div></div>

<h2 id="2使用定制数据集进行训练">（2）使用定制数据集进行训练</h2>

<p><strong>MMDetection</strong> 推荐将数据集重新组织为 <strong>COCO</strong> 格式。</p>

<p>通过修改配置文件加载数据集：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># 1. 修改数据集路径
</span><span class="n">data_root</span> <span class="o">=</span> <span class="s">'/data/zhengzj.zzj/wheat_head_counting/'</span>
<span class="c1"># 2. 修改类别名称
</span><span class="n">class_name</span> <span class="o">=</span> <span class="p">(</span><span class="s">'Wheat Head'</span><span class="p">,</span> <span class="p">)</span>
<span class="n">num_classes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_name</span><span class="p">)</span>
<span class="n">metainfo</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="n">class_name</span><span class="p">,</span> <span class="n">palette</span><span class="o">=</span><span class="p">[(</span><span class="mi">220</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">60</span><span class="p">)])</span>

<span class="n">train_dataloader</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span>
        <span class="n">metainfo</span><span class="o">=</span><span class="n">metainfo</span><span class="p">,</span>
        <span class="c1"># 3. 修改标注文件路径
</span>        <span class="n">ann_file</span><span class="o">=</span><span class="s">'train.json'</span><span class="p">,</span>
        <span class="c1"># 4. 修改图像路径
</span>        <span class="n">data_prefix</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s">'train/'</span><span class="p">)))</span>
</code></pre></div></div>

<h2 id="3类别不平衡数据集的重采样">（3）类别不平衡数据集的重采样</h2>
<ul>
  <li>参考论文：<a href="https://arxiv.org/abs/1908.03195">LVIS: A Dataset for Large Vocabulary Instance Segmentation</a></li>
  <li>代码位置：<code class="language-plaintext highlighter-rouge">./mmdet/datasets/dataset_wrappers.py</code></li>
</ul>

<p>对于<strong>类别不平衡(class imbalanced)</strong>的数据集，引入重采样的策略。即对于出现较少的类别对应的数据，将其重复采样多次用于扩充数据集；对于图像任务，每张图像采样的次数是由其<strong>重复因子(repeat factor)</strong>决定。图像$I$的重复因子$r(I)$定义为图像中最稀少的类别的重复因子:$r(I) = max_{c \in I} r(c)$；类别$c$的重复因子$r(c)$是由该类别在图像中出现的频率$f(c)$和人为给定的阈值$t$共同决定:$r(c) = \mathop{\max}(1, \sqrt{\frac{t}{f(c)}})$。</p>

<p><strong>mmdet</strong>提供了<strong>ClassBalancedDataset</strong>类用于除了类别不平衡的数据集。设置参数<code class="language-plaintext highlighter-rouge">oversample_thr=1e-3</code>，出现频率低于该值的类别会被重复采样，重采样的程度由其重复因子决定。</p>

<p>如对数据集<code class="language-plaintext highlighter-rouge">Dataset_A</code>设置参数<code class="language-plaintext highlighter-rouge">oversample_thr=1e-3</code>，则修改<strong>config</strong>文件如下：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">### 修改前：
</span><span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="p">...</span>
    <span class="n">train</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s">'Dataset_A'</span><span class="p">,</span>
        <span class="n">ann_file</span><span class="o">=</span><span class="s">'train.json'</span><span class="p">,</span>
        <span class="n">img_prefix</span><span class="o">=</span><span class="s">'train-images/'</span><span class="p">,</span>
        <span class="n">pipeline</span><span class="o">=</span><span class="n">train_pipeline</span><span class="p">),</span>
    <span class="p">...)</span>

<span class="c1">### 修改后：
</span><span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="p">...</span>
    <span class="n">train</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s">'ClassBalancedDataset'</span><span class="p">,</span>
        <span class="n">oversample_thr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>  <span class="c1"># This is the original config of Dataset_A
</span>            <span class="nb">type</span><span class="o">=</span><span class="s">'Dataset_A'</span><span class="p">,</span>
            <span class="n">ann_file</span><span class="o">=</span><span class="s">'train.json'</span><span class="p">,</span>
            <span class="n">img_prefix</span><span class="o">=</span><span class="s">'train-images/'</span><span class="p">,</span>
            <span class="n">pipeline</span><span class="o">=</span><span class="n">train_pipeline</span><span class="p">),</span>
        <span class="p">),</span>
    <span class="p">...)</span>
</code></pre></div></div>

<h2 id="4训练时应用图像的数据增强">（4）训练时应用图像的数据增强</h2>
<ul>
  <li>参考论文：<a href="https://www.mdpi.com/2078-2489/11/2/125">Albumentations: Fast and Flexible Image Augmentations</a></li>
</ul>

<p>使用<a href="https://0809zheng.github.io/2021/06/15/albumentation.html">Albumentations</a>库为图像进行数据增强。<strong>Albumentations</strong>已经集成在<strong>mmdetection</strong>框架下。使用时直接修改<code class="language-plaintext highlighter-rouge">config</code>文件内的<code class="language-plaintext highlighter-rouge">train_pipeline</code>即可：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">albu_train_transforms</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'HorizontalFlip'</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'OneOf'</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'Blur'</span><span class="p">,</span> <span class="n">blur_limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'MedianBlur'</span><span class="p">,</span> <span class="n">blur_limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="n">p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">),</span>
<span class="p">]</span>

<span class="n">train_pipeline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'LoadImageFromFile'</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'LoadAnnotations'</span><span class="p">,</span> <span class="n">with_bbox</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'Albu'</span><span class="p">,</span> <span class="n">transforms</span><span class="o">=</span><span class="n">albu_train_transforms</span><span class="p">),</span>  <span class="c1"># 数据增强
</span>    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'Resize'</span><span class="p">,</span> <span class="n">img_scale</span><span class="o">=</span><span class="p">(</span><span class="mi">1333</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="n">keep_ratio</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'RandomFlip'</span><span class="p">,</span> <span class="n">flip_ratio</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s">'Normalize'</span><span class="p">,</span>
        <span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mf">123.675</span><span class="p">,</span> <span class="mf">116.28</span><span class="p">,</span> <span class="mf">103.53</span><span class="p">],</span>
        <span class="n">std</span><span class="o">=</span><span class="p">[</span><span class="mf">58.395</span><span class="p">,</span> <span class="mf">57.12</span><span class="p">,</span> <span class="mf">57.375</span><span class="p">],</span>
        <span class="n">to_rgb</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'Pad'</span><span class="p">,</span> <span class="n">size_divisor</span><span class="o">=</span><span class="mi">32</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'DefaultFormatBundle'</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'Collect'</span><span class="p">,</span> <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="s">'img'</span><span class="p">,</span> <span class="s">'gt_bboxes'</span><span class="p">,</span> <span class="s">'gt_labels'</span><span class="p">])</span>
<span class="p">]</span>
</code></pre></div></div>

<h2 id="5toolsanalysis_toolsanalyze_logspy">（5）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/analyze_logs.py</code></h2>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/analyze_logs.py</code>根据给定的训练日志文件(<strong>.json</strong>格式)绘制损失曲线与<strong>mAP</strong>曲线。使用前需要安装依赖库：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">seaborn</span>
</code></pre></div></div>

<h3 id="-绘制学习曲线">⚪ 绘制学习曲线</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">analyze_logs</span><span class="p">.</span><span class="n">py</span> <span class="n">plot_curve</span> \
<span class="n">log</span><span class="p">.</span><span class="n">json</span> \ <span class="c1"># 读取训练日志，如果同时读取多个则并行写入：log1.json log2.json
</span><span class="p">[</span><span class="o">--</span><span class="n">keys</span> <span class="err">$</span><span class="p">{</span><span class="n">KEYS</span><span class="p">}]</span> \ <span class="c1"># 损失类型：loss_cls loss_bbox bbox_mAP
</span><span class="p">[</span><span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">interval</span> <span class="err">$</span><span class="p">{</span><span class="n">EVALUATION_INTERVAL</span><span class="p">}]</span> \
<span class="p">[</span><span class="o">--</span><span class="n">title</span> <span class="err">$</span><span class="p">{</span><span class="n">TITLE</span><span class="p">}]</span> \
<span class="p">[</span><span class="o">--</span><span class="n">legend</span> <span class="err">$</span><span class="p">{</span><span class="n">LEGEND</span><span class="p">}]</span> \ <span class="c1"># 图例注释，多个曲线则并行写入：run1 run2
</span><span class="p">[</span><span class="o">--</span><span class="n">backend</span> <span class="err">$</span><span class="p">{</span><span class="n">BACKEND</span><span class="p">}]</span> \
<span class="p">[</span><span class="o">--</span><span class="n">style</span> <span class="err">$</span><span class="p">{</span><span class="n">STYLE</span><span class="p">}]</span> \
<span class="p">[</span><span class="o">--</span><span class="n">out</span> <span class="err">$</span><span class="p">{</span><span class="n">OUT_FILE</span><span class="p">}]</span> <span class="c1"># 图像存储位置：losses.pdf
</span></code></pre></div></div>

<h3 id="-评估训练速度">⚪ 评估训练速度</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">analyze_logs</span><span class="p">.</span><span class="n">py</span> <span class="n">cal_train_time</span> <span class="n">log</span><span class="p">.</span><span class="n">json</span> <span class="p">[</span><span class="o">--</span><span class="n">include</span><span class="o">-</span><span class="n">outliers</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="6toolsanalysis_toolsoptimize_anchorspyanchor尺寸先验">（6）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/optimize_anchors.py</code>：Anchor尺寸先验</h2>

<p>对于<strong>anchor-based</strong>的目标检测器，可以人为设置<strong>Anchor</strong>尺寸先验。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">optimize_anchors</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG</span><span class="p">}</span> \
    <span class="o">--</span><span class="n">algorithm</span> \ <span class="err">$</span> <span class="n">方法</span> <span class="n">k</span><span class="o">-</span><span class="n">means</span> <span class="n">或</span>  <span class="n">differential_evolution</span>
    <span class="o">--</span><span class="nb">input</span><span class="o">-</span><span class="n">shape</span> <span class="err">$</span><span class="p">{</span><span class="n">INPUT_SHAPE</span> <span class="p">[</span><span class="n">WIDTH</span> <span class="n">HEIGHT</span><span class="p">]}</span> \
    <span class="o">--</span><span class="n">output</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="p">{</span><span class="n">OUTPUT_DIR</span><span class="p">}</span> <span class="c1"># 结果存储路径
</span></code></pre></div></div>

<h2 id="7toolsanalysis_toolsmotbrowse_datasetpy浏览数据集">（7）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/mot/browse_dataset.py</code>：浏览数据集</h2>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/mot/browse_dataset.py</code>可以浏览数据集，用于检查数据集标注是否正确：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">browse_dataset</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">interval</span> <span class="err">$</span><span class="p">{</span><span class="n">SHOW_INTERVAL</span><span class="p">}]</span>
</code></pre></div></div>

<h1 id="2-评估测试结果">2. 评估测试结果</h1>

<ol>
  <li><code class="language-plaintext highlighter-rouge">tools/test.py</code>：获取测试结果</li>
  <li><code class="language-plaintext highlighter-rouge">tta_model</code>和<code class="language-plaintext highlighter-rouge">tta_pipeline</code>：测试时增强</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/analyze_results.py</code>：结果分析</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/fusion_results.py</code>：多模型融合预测</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/get_flops.py</code>：模型复杂度分析</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/benchmark.py</code>：FPS分析</li>
  <li><code class="language-plaintext highlighter-rouge">tools/analysis_tools/confusion_matrix.py</code>绘制混淆矩阵</li>
</ol>

<h2 id="1toolstestpy获取测试结果">（1）<code class="language-plaintext highlighter-rouge">tools/test.py</code>：获取测试结果</h2>

<p><code class="language-plaintext highlighter-rouge">tools/test.py</code>可用于获取测试结果。<strong>MMDetection</strong>中的测试集其实是验证集，需要在配置文件中同时指定图像路径与对应的标注文件路径（不妨设置与验证集相同）。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">val_dataloader</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">dataset</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">metainfo</span><span class="o">=</span><span class="n">metainfo</span><span class="p">,</span>
        <span class="n">data_root</span><span class="o">=</span><span class="n">data_root</span><span class="p">,</span>
        <span class="n">ann_file</span><span class="o">=</span><span class="s">'val.json'</span><span class="p">,</span>
        <span class="n">data_prefix</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">img</span><span class="o">=</span><span class="s">'val/'</span><span class="p">)))</span>
<span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">val_dataloader</span>

<span class="n">val_evaluator</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">ann_file</span><span class="o">=</span><span class="n">data_root</span> <span class="o">+</span> <span class="s">'val.json'</span><span class="p">)</span>
<span class="n">test_evaluator</span> <span class="o">=</span> <span class="n">val_evaluator</span>
</code></pre></div></div>

<p>测试结果将会保存为<strong>pickle</strong>文件：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Single-gpu testing
</span><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">out</span> <span class="err">$</span><span class="p">{</span><span class="n">RESULT_FILE</span><span class="p">}]</span> \ <span class="c1"># 输出pkl文件路径 results.pkl
</span>    <span class="p">[</span><span class="o">--</span><span class="n">show</span><span class="p">]</span> \ <span class="c1"># 如果指定，检测结果将绘制在图像上并显示在新窗口中
</span>    <span class="p">[</span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="nb">dir</span><span class="p">]</span> \ <span class="c1"># 如果指定，检测结果将绘制在图像上并保存到指定目录
</span>    <span class="p">[</span><span class="o">--</span><span class="n">work</span><span class="o">-</span><span class="nb">dir</span><span class="p">]</span> \ <span class="c1"># 如果指定，包含评估指标的检测结果将保存到指定目录
</span>    <span class="p">[</span><span class="o">--</span><span class="n">cfg</span><span class="o">-</span><span class="n">options</span> <span class="s">'Key=value'</span><span class="p">]</span> <span class="c1"># 覆盖配置文件中的键值对
</span>
<span class="c1"># CPU: disable GPUs and run single-gpu testing script
</span><span class="n">export</span> <span class="n">CUDA_VISIBLE_DEVICES</span><span class="o">=-</span><span class="mi">1</span>
<span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">out</span> <span class="err">$</span><span class="p">{</span><span class="n">RESULT_FILE</span><span class="p">}]</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">show</span><span class="p">]</span>

<span class="c1"># Multi-gpu testing
</span><span class="n">bash</span> <span class="n">tools</span><span class="o">/</span><span class="n">dist_test</span><span class="p">.</span><span class="n">sh</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">GPU_NUM</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">out</span> <span class="err">$</span><span class="p">{</span><span class="n">RESULT_FILE</span><span class="p">}]</span>
</code></pre></div></div>

<h3 id="-通过--cfg-options修改配置文件-1">⚪ 通过<code class="language-plaintext highlighter-rouge">--cfg-options</code>修改配置文件</h3>

<p>测试时还可以通过<code class="language-plaintext highlighter-rouge">--cfg-options</code>传递配置文件键值对的修改信息，比如测试时输出所有类别的<strong>AP</strong>值：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">dist_test</span><span class="p">.</span><span class="n">sh</span> \
    <span class="p">...</span>
    <span class="o">--</span><span class="n">cfg</span><span class="o">-</span><span class="n">options</span> <span class="n">test_evaluator</span><span class="p">.</span><span class="n">classwise</span><span class="o">=</span><span class="bp">True</span>
</code></pre></div></div>

<p>或者测试时进行批量图像推理：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">dist_test</span><span class="p">.</span><span class="n">sh</span> \
    <span class="p">...</span>
    <span class="o">--</span><span class="n">cfg</span><span class="o">-</span><span class="n">options</span> <span class="n">test_dataloader</span><span class="p">.</span><span class="n">batch_size</span><span class="o">=</span><span class="mi">2</span>
</code></pre></div></div>

<h2 id="2tta_model和tta_pipeline测试时增强">（2）<code class="language-plaintext highlighter-rouge">tta_model</code>和<code class="language-plaintext highlighter-rouge">tta_pipeline</code>：测试时增强</h2>

<p><strong>测试时增强（TTA）</strong>是在测试阶段使用的数据增强策略。它对同一图像的不同增强版本（例如翻转和缩放）进行模型推理，然后平均每个增强图像的预测以获得更准确的结果。</p>

<p>使用 <strong>TTA</strong> 首先需要在配置文件中添加<code class="language-plaintext highlighter-rouge">tta_model</code>和<code class="language-plaintext highlighter-rouge">tta_pipeline</code>：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tta_model</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="nb">type</span><span class="o">=</span><span class="s">'DetTTAModel'</span><span class="p">,</span>
    <span class="n">tta_cfg</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">nms</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                   <span class="nb">type</span><span class="o">=</span><span class="s">'nms'</span><span class="p">,</span>
                   <span class="n">iou_threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                   <span class="n">max_per_img</span><span class="o">=</span><span class="mi">100</span><span class="p">))</span>

<span class="n">img_scales</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">1333</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="p">(</span><span class="mi">666</span><span class="p">,</span> <span class="mi">400</span><span class="p">),</span> <span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1200</span><span class="p">)]</span>
<span class="n">tta_pipeline</span> <span class="o">=</span> <span class="p">[</span>
    <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'LoadImageFromFile'</span><span class="p">,</span>
        <span class="n">backend_args</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
    <span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s">'TestTimeAug'</span><span class="p">,</span>
        <span class="n">transforms</span><span class="o">=</span><span class="p">[[</span> <span class="c1">#  3 次多尺度变换
</span>            <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'Resize'</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">s</span><span class="p">,</span> <span class="n">keep_ratio</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">img_scales</span>
        <span class="p">],</span> <span class="p">[</span> <span class="c1">#  2 次翻转变换（翻转和不翻转）
</span>            <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'RandomFlip'</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span>
            <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">'RandomFlip'</span><span class="p">,</span> <span class="n">prob</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
        <span class="p">],</span> <span class="p">[</span>
            <span class="nb">dict</span><span class="p">(</span> <span class="c1"># 使用 PackDetInputs 将图像打包成最终结果
</span>               <span class="nb">type</span><span class="o">=</span><span class="s">'PackDetInputs'</span><span class="p">,</span>
               <span class="n">meta_keys</span><span class="o">=</span><span class="p">(</span><span class="s">'img_id'</span><span class="p">,</span> <span class="s">'img_path'</span><span class="p">,</span> <span class="s">'ori_shape'</span><span class="p">,</span>
                       <span class="s">'img_shape'</span><span class="p">,</span> <span class="s">'scale_factor'</span><span class="p">,</span> <span class="s">'flip'</span><span class="p">,</span>
                       <span class="s">'flip_direction'</span><span class="p">))</span>
       <span class="p">]])]</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">--tta</code>在运行测试脚本时进行设置：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Single-gpu testing
</span><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">test</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">tta</span><span class="p">]</span>
</code></pre></div></div>

<h2 id="3toolsanalysis_toolsanalyze_resultspy结果分析">（3）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/analyze_results.py</code>：结果分析</h2>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/analyze_results.py</code>计算测试集中每张图像的<strong>mAP</strong>，并存储/展示得分最高/最低的<strong>topK</strong>张图像预测结果。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">analyze_results</span><span class="p">.</span><span class="n">py</span> \
      <span class="err">$</span><span class="p">{</span><span class="n">CONFIG</span><span class="p">}</span> \          <span class="c1"># 此处应指定测试配置文件路径！
</span>      <span class="err">$</span><span class="p">{</span><span class="n">PREDICTION_PATH</span><span class="p">}</span> \ <span class="c1"># 输出pkl文件路径
</span>      <span class="err">$</span><span class="p">{</span><span class="n">SHOW_DIR</span><span class="p">}</span> \        <span class="c1"># 预测结果存储路径
</span>      <span class="p">[</span><span class="o">--</span><span class="n">show</span><span class="p">]</span> \           <span class="c1"># 是否展示图像
</span>      <span class="p">[</span><span class="o">--</span><span class="n">wait</span><span class="o">-</span><span class="n">time</span> <span class="err">$</span><span class="p">{</span><span class="n">WAIT_TIME</span><span class="p">}]</span> \ <span class="c1"># 图像展示间隔
</span>      <span class="p">[</span><span class="o">--</span><span class="n">topk</span> <span class="err">$</span><span class="p">{</span><span class="n">TOPK</span><span class="p">}]</span> \   <span class="c1"># 默认为20
</span>      <span class="p">[</span><span class="o">--</span><span class="n">show</span><span class="o">-</span><span class="n">score</span><span class="o">-</span><span class="n">thr</span> <span class="err">$</span><span class="p">{</span><span class="n">SHOW_SCORE_THR</span><span class="p">}]</span> \ <span class="c1"># 过滤得分较低的预测结果
</span>      <span class="p">[</span><span class="o">--</span><span class="n">cfg</span><span class="o">-</span><span class="n">options</span> <span class="err">$</span><span class="p">{</span><span class="n">CFG_OPTIONS</span><span class="p">}]</span>
</code></pre></div></div>

<h2 id="4toolsanalysis_toolsfusion_resultspy多模型融合预测">（4）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/fusion_results.py</code>：多模型融合预测</h2>

<ul>
  <li>论文：<a href="https://arxiv.org/abs/1910.13302">Weighted boxes fusion: Ensembling boxes from different object detection models</a></li>
</ul>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/fusion_results.py</code>能够融合多个模型的检测结果，采用<strong>Weighted Boxes Fusion(WBF)</strong>方法。</p>

<p><strong>WBF</strong>方法假设使用$N$个不同模型对相同的数据集进行边界框预测，然后做如下操作：</p>
<ol>
  <li>将每个模型的每个预测边界框加入到一个单独的列表$\mathbf B$中，按照置信度$\mathbf C$进行递减排序；</li>
  <li>分别声明空列表$\mathbf L$和$\mathbf F$为边界框簇和融合后的边界框。列表$\mathbf L$中的每个位置可以包含一个边界框或者一个边界框集合，形成一个簇。$\mathbf F$中每个位置只包含一个边界框，对应从相应的$\mathbf L$中的簇中融合出来的边界框；</li>
  <li>在一个循环中迭代$\mathbf B$中的预测框，尝试找到列表$\mathbf F$中的一个匹配边界框。匹配的定义为边界框<strong>IoU&gt;</strong>阈值，该实验阈值设置为$0.55$；</li>
  <li>如果找到匹配，则将该框添加到与列表$\mathbf F$中匹配框对应的列表$\mathbf L$中的$\mathbf{pos}$处；</li>
  <li>如果未找到匹配，则将$\mathbf B$作为一个新的实体加入到列表$\mathbf L$和$\mathbf F$的最后，继续对$\mathbf B$中下一个边界框进行处理；</li>
  <li>使用所有的在簇$\mathbf{L[pos]}$中的$T$个边界框加权计算$\mathbf{F[pos]}$中边界框的坐标和置信度得分（置信度越高的边界框对于融合边界框的坐标做出的贡献越大）：$C = \frac{\sum_t^TC_t}{T},X/Y=\frac{\sum_t^TC_t\cdot X_t/Y_t}{\sum_t^TC_t}$</li>
  <li>当$\mathbf B$中的所有边界框都被处理了，对$\mathbf F$列表的置信度得分重新估计：乘上簇中的边界框个数并除以模型数目（当簇中边界框数目少的时候，该融合框的置信度应该降低）：$C = C \cdot \frac{\min(T,N)}{N}$</li>
</ol>

<p><strong>WBF</strong>方法目前仅支持<strong>COCO</strong>格式的预测结果：</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">fuse_results</span><span class="p">.</span><span class="n">py</span> \
       <span class="err">$</span><span class="p">{</span><span class="n">PRED_RESULTS</span><span class="p">}</span> \ <span class="c1"># 提供.json预测结果，多个预测结果并列
</span>       <span class="p">[</span><span class="o">--</span><span class="n">annotation</span> <span class="err">$</span><span class="p">{</span><span class="n">ANNOTATION</span><span class="p">}]</span> \ <span class="c1"># 提供标签文件
</span>       <span class="p">[</span><span class="o">--</span><span class="n">weights</span> <span class="err">$</span><span class="p">{</span><span class="n">WEIGHTS</span><span class="p">}]</span> \ <span class="c1"># 每个模型的预测权重
</span>       <span class="p">[</span><span class="o">--</span><span class="n">fusion</span><span class="o">-</span><span class="n">iou</span><span class="o">-</span><span class="n">thr</span> <span class="err">$</span><span class="p">{</span><span class="n">FUSION_IOU_THR</span><span class="p">}]</span> \ <span class="c1"># 边界框匹配阈值，默认0.55
</span>       <span class="p">[</span><span class="o">--</span><span class="n">skip</span><span class="o">-</span><span class="n">box</span><span class="o">-</span><span class="n">thr</span> <span class="err">$</span><span class="p">{</span><span class="n">SKIP_BOX_THR</span><span class="p">}]</span> \ <span class="c1"># 过滤得分较低的预测结果
</span>       <span class="p">[</span><span class="o">--</span><span class="n">conf</span><span class="o">-</span><span class="nb">type</span> <span class="err">$</span><span class="p">{</span><span class="n">CONF_TYPE</span><span class="p">}]</span> \ <span class="c1"># 置信度加权方式：avg平均，max最大
</span>       <span class="p">[</span><span class="o">--</span><span class="nb">eval</span><span class="o">-</span><span class="n">single</span> <span class="err">$</span><span class="p">{</span><span class="n">EVAL_SINGLE</span><span class="p">}]</span> \ <span class="c1"># 开启后，分别评估单个模型
</span>       <span class="p">[</span><span class="o">--</span><span class="n">save</span><span class="o">-</span><span class="n">fusion</span><span class="o">-</span><span class="n">results</span> <span class="err">$</span><span class="p">{</span><span class="n">SAVE_FUSION_RESULTS</span><span class="p">}]</span> \ <span class="c1"># 开启后，存储融合结果
</span>       <span class="p">[</span><span class="o">--</span><span class="n">out</span><span class="o">-</span><span class="nb">dir</span> <span class="err">$</span><span class="p">{</span><span class="n">OUT_DIR</span><span class="p">}]</span> <span class="c1"># 存储结果的路径
</span></code></pre></div></div>

<h2 id="5toolsanalysis_toolsget_flopspy模型复杂度分析">（5）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/get_flops.py</code>：模型复杂度分析</h2>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/get_flops.py</code>能够分析模型的<strong>FLOPs</strong>和参数量。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">get_flops</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG_FILE</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">shape</span> <span class="err">$</span><span class="p">{</span><span class="n">INPUT_SHAPE</span><span class="p">}]</span> <span class="c1"># 格式：H W
</span></code></pre></div></div>

<p>一些常见结论：</p>
<ul>
  <li>默认输入尺寸为$(1, 3, 1280, 800)$</li>
  <li><strong>FLOPs</strong>与输入尺寸相关，参数量与输入尺寸无关</li>
  <li>一些操作（如<strong>GN</strong>或自定义操作）没有计入<strong>FLOPs</strong></li>
  <li>两阶段检测器的<strong>FLOPs</strong>与<strong>proposal</strong>数量有关</li>
</ul>

<h2 id="6toolsanalysis_toolsbenchmarkpyfps分析">（6）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/benchmark.py</code>：FPS分析</h2>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/benchmark.py</code>能够计算<strong>FPS</strong>，即网络每秒处理的图像帧数（包括前向传播与后处理过程）。通常只使用单<strong>GPU</strong>配置以获得准确的<strong>FPS</strong>估计。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">torch</span><span class="p">.</span><span class="n">distributed</span><span class="p">.</span><span class="n">launch</span> <span class="o">--</span><span class="n">nproc_per_node</span><span class="o">=</span><span class="mi">1</span> <span class="o">--</span><span class="n">master_port</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">PORT</span><span class="p">}</span> \
    <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">benchmark</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG</span><span class="p">}</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">checkpoint</span> <span class="err">$</span><span class="p">{</span><span class="n">CHECKPOINT</span><span class="p">}]</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">repeat</span><span class="o">-</span><span class="n">num</span> <span class="err">$</span><span class="p">{</span><span class="n">REPEAT_NUM</span><span class="p">}]</span> \
    <span class="p">[</span><span class="o">--</span><span class="nb">max</span><span class="o">-</span><span class="nb">iter</span> <span class="err">$</span><span class="p">{</span><span class="n">MAX_ITER</span><span class="p">}]</span> \
    <span class="p">[</span><span class="o">--</span><span class="n">log</span><span class="o">-</span><span class="n">interval</span> <span class="err">$</span><span class="p">{</span><span class="n">LOG_INTERVAL</span><span class="p">}]</span> \
    <span class="o">--</span><span class="n">launcher</span> <span class="n">pytorch</span>
</code></pre></div></div>

<h2 id="7toolsanalysis_toolsconfusion_matrixpy绘制混淆矩阵">（7）<code class="language-plaintext highlighter-rouge">tools/analysis_tools/confusion_matrix.py</code>绘制混淆矩阵</h2>

<p><code class="language-plaintext highlighter-rouge">tools/analysis_tools/confusion_matrix.py</code>能够根据预测的<strong>.pkl</strong>文件绘制不同类别之间的混淆矩阵。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">python</span> <span class="n">tools</span><span class="o">/</span><span class="n">analysis_tools</span><span class="o">/</span><span class="n">confusion_matrix</span><span class="p">.</span><span class="n">py</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">CONFIG</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">DETECTION_RESULTS</span><span class="p">}</span> \
    <span class="err">$</span><span class="p">{</span><span class="n">SAVE_DIR</span><span class="p">}</span> <span class="o">--</span><span class="n">show</span>
</code></pre></div></div>

    </article>

    
    <div class="social-share-wrapper">
      <div class="social-share"></div>
    </div>
    
  </div>

  <section class="author-detail">
    <section class="post-footer-item author-card">
      <div class="avatar">
        <img src="https://avatars.githubusercontent.com/u/46283762?v=4&size=64" alt="">
      </div>
      <div class="author-name" rel="author">DawsonWen</div>
      <div class="bio">
        <p></p>
      </div>
      
      <ul class="sns-links">
        
        <li>
          <a href="//github.com/Sologala" target="_blank">
                    <i class="iconfont icon-github"></i>
                </a>
        </li>
        
      </ul>
      
    </section>
    <section class="post-footer-item read-next">
      
      <div class="read-next-item">
        <a href="/2021/06/21/ganbert.html" class="read-next-link"></a>
        <section>
          <span>GAN-BERT: Generative Adversarial Learning for Robust Text Classification with a Bunch of Labeled Examples</span>
          <p>  GAN-BERT：使用GAN进行半监督的BERT训练.</p>
        </section>
        
        <div class="filter"></div>
        <img src="https://pic.imgdb.cn/item/60d1d822844ef46bb273a157.jpg" alt="">
        
     </div>
      

      
      <div class="read-next-item">
        <a href="/2021/06/20/hrnas.html" class="read-next-link"></a>
          <section>
            <span>HR-NAS: Searching Efficient High-Resolution Neural Architectures with Lightweight Transformers</span>
            <p>  HR-NAS：通过轻量级Transformer搜索高效高分辨率网络结构.</p>
          </section>
          
          <div class="filter"></div>
          <img src="https://pic.imgdb.cn/item/668e4a5ed9c307b7e98c0f80.png" alt="">
          
      </div>
      
    </section>
    
    <section class="post-footer-item comment">
      <div id="disqus_thread"></div>
      <div id="gitalk_container"></div>
    </section>
  </section>

  <!-- <footer class="g-footer">
  <script type='text/javascript' id='clustrmaps' src='//cdn.clustrmaps.com/map_v2.js?cl=ffffff&w=800&t=m&d=WWuzUTmOt8V9vdtIQd5uqrEcKsRg4IiPuy9gg21CQO8'></script>
  <section>DawsonWen的个人网站 ©
  
  
    2020
    -
  
  2024
  </section>
  <section>Powered by <a href="//jekyllrb.com">Jekyll</a></section>
</footer>
 -->

  <script src="/assets/js/social-share.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
  <script>
    socialShare('.social-share', {
      sites: [
        
          'wechat'
          ,
          
        
          'weibo'
          ,
          
        
          'douban'
          ,
          
        
          'twitter'
          
        
      ],
      wechatQrcodeTitle: "分享到微信朋友圈",
      wechatQrcodeHelper: '<p>扫码后点击右上角</p><p>将本文分享至朋友圈</p>'
    });
  </script>

  
	
  

  <script src="/assets/js/prism.js"></script>
  <script src="/assets/js/index.min.js"></script>
</body>

</html>
